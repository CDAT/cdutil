<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cdutil.times &#8212; CDUtil 2.8 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cdutil.times</h1><div class="highlight"><pre>
<span></span><span class="c1"># Adapted for numpy/ma/cdms2 by convertcdms.py</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">MV2</span>
<span class="kn">import</span> <span class="nn">cdms2</span><span class="o">,</span><span class="nn">cdtime</span><span class="o">,</span><span class="nn">string</span><span class="o">,</span><span class="nn">types</span><span class="o">,</span><span class="nn">numpy.ma</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">cdat_info</span>

<div class="viewcode-block" id="centroid"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.centroid">[docs]</a><span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the centroid of a bunch of points.</span>
<span class="sd">    Authors: Charles Doutriaux/Karl Taylor</span>
<span class="sd">    Date: April 2001</span>
<span class="sd">    :param msk: A slab (cdms2 TransientVariable)</span>
<span class="sd">    :type msk: cdms2.tvariable.TransientVariable</span>

<span class="sd">    :param bounds: The bounds of the overall thing.</span>
<span class="sd">    :param coords : The coordinates spanned by each subset</span>

<span class="sd">    :returns: A slab representing the centroid.  Values are between 0 (data evenly distributed evenly across the center)</span>
<span class="sd">                and +/-1 (data not evenly distributed). Centroid is 1D less than msk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># determine the length,spread, shape and mean</span>
    <span class="n">sh</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mean</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span> <span class="c1"># if MV2 then gets the bounds from there</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msk</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msk</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">sw</span><span class="o">=</span><span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">w</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># width</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">sw</span><span class="o">=</span><span class="n">sw</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">msk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sw</span><span class="o">=</span><span class="n">sw</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="o">-</span><span class="n">mean</span> <span class="c1"># location</span>
        <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># factor to multiply by plus normalization</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">msk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">msk</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">w</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">msk</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
    <span class="n">msk</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># sums it</span>
    <span class="n">sw</span><span class="o">=</span><span class="n">sw</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="o">/</span><span class="n">sw</span>
    <span class="k">return</span> <span class="n">msk</span></div>

<div class="viewcode-block" id="cyclicalcentroid"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.cyclicalcentroid">[docs]</a><span class="k">def</span> <span class="nf">cyclicalcentroid</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the centroid, but this assumes cyclical axis.</span>

<span class="sd">    :Example:</span>

<span class="sd">        .. doctest:: times_cyclicalcentroid</span>

<span class="sd">            &gt;&gt;&gt; import cdms2</span>
<span class="sd">            &gt;&gt;&gt; import vcs</span>
<span class="sd">            &gt;&gt;&gt; vcs.download_sample_data_files()</span>
<span class="sd">            &gt;&gt;&gt; f=cdms2.open(vcs.sampledata + &#39;/clt.nc&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s=f(&#39;clt&#39;)</span>
<span class="sd">            &gt;&gt;&gt; cyclecentroid=cyclicalcentroid(s,bounds)</span>

<span class="sd">    :param s: A slab (cdms2 TransientVariable)</span>
<span class="sd">    :type s: cdms2.tvariable.TransientVariable</span>
<span class="sd">    :param bounds: The bounds of the overall thing</span>
<span class="sd">    :param coords: The coordinates spanned by each subset</span>

<span class="sd">    :returns: A slab representing the cyclecentroid, which is the same shape as s but without the 1st dimension</span>
<span class="sd">    :rtype: cdms2.tvariable.TransientVariable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span> <span class="c1"># if MV2 then gets the bounds from there</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">length</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nax</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">nax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">length</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">nax</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">length</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1"># Places the point evenly around the axis</span>
    <span class="c1"># Compute the centroid on x and y</span>
    <span class="n">xc</span><span class="o">=</span><span class="n">centroid</span><span class="p">(</span><span class="n">s</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">nax</span><span class="p">))</span>
    <span class="n">yc</span><span class="o">=</span><span class="n">centroid</span><span class="p">(</span><span class="n">s</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">nax</span><span class="p">))</span>
    <span class="c1"># compute the new centroid</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xc</span><span class="o">*</span><span class="n">xc</span><span class="o">+</span><span class="n">yc</span><span class="o">*</span><span class="n">yc</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span></div>

<div class="viewcode-block" id="getMonthString"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.getMonthString">[docs]</a><span class="k">def</span> <span class="nf">getMonthString</span><span class="p">(</span><span class="n">my_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a list of months creates the string representing the sequence&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">my_list</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">TupleType</span><span class="p">]:</span>
        <span class="n">my_list</span><span class="o">=</span><span class="p">[</span><span class="n">my_list</span><span class="p">]</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span><span class="s1">&#39;JANUARY&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="s1">&#39;FEBRUARY&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="s1">&#39;MARCH&#39;</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span><span class="s1">&#39;APRIL&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span><span class="s1">&#39;MAY&#39;</span><span class="p">,</span><span class="mi">6</span><span class="p">:</span><span class="s1">&#39;JUNE&#39;</span><span class="p">,</span>
        <span class="mi">7</span><span class="p">:</span><span class="s1">&#39;JULY&#39;</span><span class="p">,</span><span class="mi">8</span><span class="p">:</span><span class="s1">&#39;AUGUST&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">:</span><span class="s1">&#39;SEPTEMBER&#39;</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">:</span><span class="s1">&#39;OCTOBER&#39;</span><span class="p">,</span><span class="mi">11</span><span class="p">:</span><span class="s1">&#39;NOVEMBER&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">:</span><span class="s1">&#39;DECEMBER&#39;</span><span class="p">}</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">my_list</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">out</span><span class="o">=</span><span class="p">[</span><span class="n">dic</span><span class="p">[</span><span class="n">my_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="getMonthIndex"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.getMonthIndex">[docs]</a><span class="k">def</span> <span class="nf">getMonthIndex</span><span class="p">(</span><span class="n">my_str</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Given a string representing a month or a season (common abrev)</span>
<span class="sd">   Returns the ordered indices of the month.</span>
<span class="sd">   Author: Krishna Achutarao</span>
<span class="sd">   Date: April 2001</span>

<span class="sd">   :param my_str: string reperesenting month or season</span>
<span class="sd">   :type my_str: str</span>

<span class="sd">   :returns: The ordered indices of the month</span>
<span class="sd">   :rtype: list</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">my_str</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">my_str</span><span class="p">)</span>
   <span class="n">mon_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;JANUARY&#39;</span><span class="p">,</span> <span class="s1">&#39;FEBRUARY&#39;</span><span class="p">,</span> <span class="s1">&#39;MARCH&#39;</span><span class="p">,</span> <span class="s1">&#39;APRIL&#39;</span><span class="p">,</span> <span class="s1">&#39;MAY&#39;</span><span class="p">,</span> <span class="s1">&#39;JUNE&#39;</span><span class="p">,</span> <span class="s1">&#39;JULY&#39;</span><span class="p">,</span>
               <span class="s1">&#39;AUGUST&#39;</span><span class="p">,</span> <span class="s1">&#39;SEPTEMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;OCTOBER&#39;</span><span class="p">,</span> <span class="s1">&#39;NOVEMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;DECEMBER&#39;</span><span class="p">]</span>
   <span class="k">if</span> <span class="n">my_str</span> <span class="ow">in</span> <span class="n">mon_list</span><span class="p">:</span>
       <span class="k">return</span> <span class="p">[</span><span class="n">mon_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">my_str</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
   <span class="c1"># end of if string.upper(my_str) in yr_arr:</span>
   <span class="c1">#</span>

   <span class="c1"># Determine if my_str is an abbreviated month, if my_str has</span>
   <span class="c1"># at least 3 characters.</span>
   <span class="c1"># * If my_str has one character, the same result will be found by using</span>
   <span class="c1">#   the &#39;yrs&#39; string below (ambiguous result because we choose the</span>
   <span class="c1">#   first matching char...)</span>
   <span class="c1"># * If my_str has 2 characters, we assume that we are looking for 2</span>
   <span class="c1">#   consecutive months that will be found with &#39;yrs&#39;</span>
   <span class="c1">#   i.e. &#39;JA&#39; -&gt; July AND August  (NOT January!)</span>
   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_str</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
       <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="n">mon_list</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">mon</span><span class="p">,</span>  <span class="n">my_str</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
               <span class="k">return</span> <span class="p">[</span><span class="n">mon_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mon</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
           <span class="c1"># end of if string.find(mon,  my_str) != -1:</span>
       <span class="c1"># end of for mon in mon_list:</span>
           
   <span class="n">yr</span> <span class="o">=</span> <span class="s1">&#39;JFMAMJJASOND&#39;</span>
   <span class="n">yrs</span> <span class="o">=</span> <span class="n">yr</span><span class="o">+</span><span class="n">yr</span>
   <span class="c1">#</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">yrs</span><span class="p">,</span> <span class="n">my_str</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
   <span class="n">month</span> <span class="o">=</span>  <span class="n">result</span> <span class="o">+</span> <span class="mi">1</span>
   <span class="n">lis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">month</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">my_str</span><span class="p">))</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lis</span><span class="p">)):</span>
       <span class="k">if</span> <span class="n">lis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span> <span class="n">lis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">12</span>
   <span class="k">return</span> <span class="n">lis</span></div>


<div class="viewcode-block" id="isMonthly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.isMonthly">[docs]</a><span class="k">def</span> <span class="nf">isMonthly</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function test if the data are monthly data from the time axis.</span>

<span class="sd">    :param s: A cdms2 TransientVariable</span>
<span class="sd">    :type s: cdms2.tvariable.TransientVariable</span>

<span class="sd">    :returns: An integer flag indicating whether s has monthly data (1), or does not (0).</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
    <span class="n">monthly</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">month1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">tim</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;months since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
      <span class="n">month2</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">tim</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;months since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
      <span class="k">if</span> <span class="n">month2</span><span class="o">-</span><span class="n">month1</span><span class="o">!=</span><span class="mi">1</span> <span class="p">:</span> <span class="n">monthly</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">return</span> <span class="n">monthly</span></div>


<div class="viewcode-block" id="mergeTime"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.mergeTime">[docs]</a><span class="k">def</span> <span class="nf">mergeTime</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">1.e20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge chronologically a bunch of slabs</span>
<span class="sd">    Version 1.0</span>
<span class="sd">    Author: Charles Doutriaux, doutriaux1@llnl.gov</span>

<span class="sd">    :Example:</span>

<span class="sd">        .. doctest:: times_mergeTime</span>

<span class="sd">            &gt;&gt;&gt; import cdms2</span>
<span class="sd">            &gt;&gt;&gt; import vcs</span>
<span class="sd">            &gt;&gt;&gt; vcs.download_sample_data_files()</span>
<span class="sd">            &gt;&gt;&gt; f=cdms2.open(vcs.sampledata + &#39;/clt.nc&#39;)</span>
<span class="sd">            &gt;&gt;&gt; clt=f(&#39;clt&#39;)</span>
<span class="sd">            &gt;&gt;&gt; u=f(&#39;u&#39;)</span>
<span class="sd">            &gt;&gt;&gt; v=f(&#39;v&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ds=[clt,u,v]</span>
<span class="sd">            &gt;&gt;&gt; mymerged=mergeTime(ds)</span>

<span class="sd">    :param ds: A list or an array of slabs to merge. Each slab MUST be in chronological order.</span>
<span class="sd">    :type ds: list</span>
<span class="sd">    :param statusbar: Integer flag indicating whether to show status bar or not.</span>
<span class="sd">    :type statusbar: int</span>
<span class="sd">    :param fill_value: Float used to set the fill value of the generated slab.</span>
<span class="sd">    :type fill_value: float</span>

<span class="sd">    :returns: A slab merging all the slabs of ds. Order is the order of the first slab</span>
<span class="sd">    :rtype: cdms2.tvariable.TransientVariable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allNone</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allNone</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">allNone</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># first determine the number of slabs</span>
    <span class="n">nslab</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">order0</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">initialgrid</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
    <span class="n">times</span><span class="o">=</span><span class="p">[[]]</span><span class="o">*</span><span class="n">nslab</span>
    <span class="n">vals</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
    <span class="c1"># Now makes sure time is first</span>
    <span class="n">timesleft</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nslab</span><span class="p">):</span>
        <span class="n">order</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">order0</span><span class="o">=</span><span class="n">order</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;t&#39;</span> <span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
        <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="n">units</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
        <span class="n">cal</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">()</span>
        <span class="n">tmpdic</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>  <span class="c1"># creates the dictionary of times not matched yet</span>
            <span class="n">t</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">tmpval</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;seconds since 2000&#39;</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span>
            <span class="n">tmpdic</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">tmpval</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpval</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">timesleft</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpdic</span><span class="p">)</span>
    <span class="n">vals</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">nt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="c1"># sys.exit()</span>
    <span class="c1"># Quick error check (no duplicate)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span><span class="o">!=</span><span class="n">nt</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">errtime</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;seconds since 2000&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">()</span>
            <span class="n">err</span><span class="o">=</span><span class="s1">&#39;Error in merging process : duplicate time point</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">errtime</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is duplicated, cannot merge&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">err</span>

    <span class="c1"># Now create the big array that will be the merged</span>
    <span class="n">sh</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">nt</span>
    <span class="n">out</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sh</span><span class="p">),</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="c1"># bounds array</span>
    <span class="n">bnds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">fvals</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">),</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">genutil</span>
        <span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span>
                <span class="n">statusbar</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">statusbar</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">statusbar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
                
            <span class="n">prev</span><span class="o">=</span><span class="n">genutil</span><span class="o">.</span><span class="n">statusbar</span><span class="p">(</span><span class="n">statusbar</span><span class="p">,</span><span class="n">prev</span><span class="o">=</span><span class="n">prev</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Merging&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># In order to speeed up, raise an execption to exit the inner loops</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nslab</span><span class="p">):</span>
                <span class="n">tim</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">timesleft</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">t</span><span class="o">=</span><span class="n">tim</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                    <span class="n">val</span><span class="o">=</span><span class="n">timesleft</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">it</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="n">vals</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">it</span><span class="p">]</span>
                        <span class="n">fvals</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">val</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">bnds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()[</span><span class="n">it</span><span class="p">]</span>
                        <span class="n">bnds</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">switchCalendars</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">(),</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">bnds</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">switchCalendars</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">(),</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">del</span><span class="p">(</span><span class="n">timesleft</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">it</span><span class="p">])</span>
                        <span class="k">raise</span> <span class="ne">Exception</span>  <span class="c1"># to exit the it and i loops</span>
                    <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="o">&gt;</span><span class="n">vals</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                        <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="n">t</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">fvals</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">designateTime</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;time&#39;</span>
    <span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
    <span class="n">t</span><span class="o">.</span><span class="n">setCalendar</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
    <span class="n">out</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">initialgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">initialgrid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="n">order0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="switchCalendars"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.switchCalendars">[docs]</a><span class="k">def</span> <span class="nf">switchCalendars</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">u1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">c2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a relative time from one calendar to another, assuming that they are in different calendars</span>

<span class="sd">    :Example:</span>

<span class="sd">        .. doctest:: times_switchCalendars</span>

<span class="sd">            &gt;&gt;&gt; switchCalendars(t1,c1,u2,c2)</span>

<span class="sd">    :param t1: A cdtime reltime object or a value. If it is a value, then u1 is needed.</span>
<span class="sd">    :param c1: cdtime calendar</span>
<span class="sd">    :param c2: cdtime calendar</span>
<span class="sd">    :param u1: units in the calendar to be converted</span>
<span class="sd">    :param u2: units in the final calendar</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">==</span><span class="n">types</span><span class="o">.</span><span class="n">IntType</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">==</span><span class="n">types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">):</span>
      <span class="n">c2</span><span class="o">=</span><span class="n">u2</span>
      <span class="n">u2</span><span class="o">=</span><span class="n">c1</span>
      <span class="n">c1</span><span class="o">=</span><span class="n">u1</span>
      <span class="n">u1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">units</span>
      <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span>
    <span class="c1"># makes t1 a cdtime object</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">u1</span><span class="p">)</span>
    <span class="c1"># Converts t1 to comptime</span>
    <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">u2</span><span class="p">,</span><span class="n">c2</span><span class="p">)</span></div>



<div class="viewcode-block" id="TimeSlicer"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.TimeSlicer">[docs]</a><span class="k">class</span> <span class="nc">TimeSlicer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Author : Charles Doutriaux: doutriaux1@llnl.gov</span>
<span class="sd">    Date: April 2001</span>

<span class="sd">    Returns masked average of specific time slices</span>
<span class="sd">    &quot;slicer&quot; determine which slices of the Transient Variable (TV) are processed</span>
<span class="sd">    &quot;criteria&quot; gets TV (with time dimension) and returns a &quot;timeless&quot; mask, used to mask the averaged slices</span>
<span class="sd">    </span>
<span class="sd">    &quot;slicer&quot;</span>
<span class="sd">      Input:</span>
<span class="sd">            - Time Axis</span>
<span class="sd">            - User argument (can be anything) (in a list if more than one argument)</span>
<span class="sd">      Output:</span>
<span class="sd">          indices             : the indices for each season:</span>
<span class="sd">                                                     [[i1,i2,...,il],</span>
<span class="sd">                                                     [j1,j2,...,jm],</span>
<span class="sd">                                                     ...,</span>
<span class="sd">                                                     [k1,k2,...kn]]</span>
<span class="sd">          bounds              : the bounds covered by each slice for each season:</span>
<span class="sd">                                                     [[[i1b1,i1b2],[i2b1,i2b2],...,[ilb1,ilb2]],</span>
<span class="sd">                                                     [[[j1b1,j1b2],[j2b1,j2b2],...,[jmb1,jmb2]],</span>
<span class="sd">                                                     ...,</span>
<span class="sd">                                                     [[k1b1,k1b2],[k2b1,k2b2],...,[knb1,knb2]]]</span>
<span class="sd">          norm                : the actual length of each &quot;season&quot;, and its start</span>
<span class="sd">                                                     [[Li,Si],</span>
<span class="sd">                                                     [Lj,Sj],</span>
<span class="sd">                                                     ...,</span>
<span class="sd">                                                     [Lk,Sk]]</span>
<span class="sd">    &quot;criteria&quot;</span>
<span class="sd">      Input:</span>
<span class="sd">            - slab : a slab</span>
<span class="sd">            - mask:  the actual percentage of data in each subset used to produce the slab</span>
<span class="sd">                     the bounds of its first (time) dimension must be correct</span>
<span class="sd">                     they will be used by centroid</span>
<span class="sd">            - spread: the begining and end time of the slice processed </span>
<span class="sd">            - User argument (can be anything)</span>
<span class="sd">      Output:</span>
<span class="sd">            - the slab, masked</span>
<span class="sd">            </span>
<span class="sd">    Once constructed the object, beside &quot;slicer&quot; and &quot;criteria&quot; has 3 functions:</span>
<span class="sd">    </span>
<span class="sd">    &quot;get&quot; : which returns the slices wanted, appropriately masked</span>
<span class="sd">       Input:</span>
<span class="sd">          slab : the slab on which to operate</span>
<span class="sd">          sliceruserargument  : anything your slicer function needs, default is None</span>
<span class="sd">          criteriauserargument: anything your criteria function needs, default is None</span>
<span class="sd">       Output:</span>
<span class="sd">          out  : averaged and masked slices of slab</span>
<span class="sd">          </span>
<span class="sd">    &quot;departures&quot; : which returns the departures of slab from the result of get</span>
<span class="sd">       Input:</span>
<span class="sd">          slab                : slab from which the we want to get the departure</span>
<span class="sd">          sliceruserargument  : anything your slicer function needs, default is None</span>
<span class="sd">          criteriauserargument: anything your criteria function needs, default is None</span>
<span class="sd">          (ref): optional     : result from get or equivalent precomputed</span>
<span class="sd">          </span>
<span class="sd">       Output:</span>
<span class="sd">          out : departure of slab from ref</span>
<span class="sd">          </span>
<span class="sd">    &quot;average&quot; : which return the average of the result of get</span>
<span class="sd">       Input:</span>
<span class="sd">          slab                : the slab on which to operate</span>
<span class="sd">          slices              : the slices for each part</span>
<span class="sd">          bounds              : the length of each slice</span>
<span class="sd">          norm                : the actual length of each &quot;season&quot;</span>
<span class="sd">          criteriaarg         : arguments for criteria thing</span>
<span class="sd">       Output:</span>
<span class="sd">          out : the average of slab, masked by criteria</span>

<span class="sd">    Example of construction:</span>
<span class="sd">    TS=TimeSlicer(slicerfunc,criteriafunc)</span>
<span class="sd">    myres=TS(myslab,[[slicerarg,[criteriaarg]])</span>
<span class="sd">    myresdeparture=TS(myslab,[[slicerarg,[criteriaarg,ref]]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slicerfunction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">criteriafunction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="o">=</span><span class="n">slicerfunction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">=</span><span class="n">criteriafunction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__call__</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        
<div class="viewcode-block" id="TimeSlicer.get"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.TimeSlicer.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slicerarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">criteriaarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param slab: the slab on which to operate</span>
<span class="sd">        :param slicerarg: anything your slicer function needs, default is None</span>
<span class="sd">        :param criteriaarg: anything your criteria function needs, default is None</span>
<span class="sd">        :param statusbar: see :py:func:`statusbar` for details</span>

<span class="sd">        :returns: averaged and masked slices of slab</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c1"># Makes sure time is first</span>
        <span class="n">initialorder</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">initialgrid</span> <span class="o">=</span> <span class="n">slab</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">initialorder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;t&#39;</span> <span class="p">:</span> <span class="n">slab</span><span class="o">=</span><span class="n">slab</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>

        <span class="c1"># retrieve the time axis</span>
        <span class="n">tim</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="c1"># Let slicer figure out wich slices we want</span>
        <span class="n">slices</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="n">slicerarg</span><span class="p">)</span>
<span class="c1">##         print &#39;Slices:&#39;,slices,len(slices)</span>
<span class="c1">##         print &#39;Bounds:&#39;,bounds</span>
<span class="c1">##         print &#39;Norm:&#39;,norm</span>
<span class="c1">##         print &#39;Slices:&#39;,slices[-3:]</span>
<span class="c1">##         print &#39;Bounds:&#39;,bounds[-3:]</span>
<span class="c1">##         print &#39;Norm:&#39;,norm[-3:]</span>
        
        <span class="c1"># Check we have something</span>
        <span class="k">if</span> <span class="n">slices</span><span class="o">==</span><span class="p">[]</span> <span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
<span class="c1">##             raise Exception,&#39;Error Slicer return nothing for: &#39;+str(slicerarg)</span>
        <span class="c1"># How many slices ?</span>
        <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="n">slices</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">norm</span><span class="p">,</span><span class="n">criteriaarg</span><span class="p">,</span><span class="n">statusbar</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
            <span class="n">out</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">out</span>
        <span class="c1"># Put the dimensions</span>
        <span class="n">out</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">slab</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">slab</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="c1"># Time axis</span>
        <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>
        <span class="n">vals</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">),</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>  <span class="c1"># time values</span>
        <span class="n">bnds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="c1"># time bounds</span>
        <span class="c1"># Retrieve the bounds</span>
        <span class="n">sh</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">b0</span><span class="o">=</span><span class="n">norm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">b1</span><span class="o">=</span><span class="n">norm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">b0</span>
            <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">b0</span><span class="p">,</span><span class="n">b1</span>
            <span class="n">v</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">+</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
        <span class="n">t</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">designateTime</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">id</span>
        <span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
        <span class="n">t</span><span class="o">.</span><span class="n">setCalendar</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">out</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
<span class="c1">##             print out.shape,w.shape</span>
            <span class="n">w</span><span class="o">=</span><span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;weights&#39;</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="n">initialorder</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">initialorder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">initialorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initialgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">initialgrid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">initialgrid</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">,</span><span class="n">w</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span></div>
            

<div class="viewcode-block" id="TimeSlicer.departures"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.TimeSlicer.departures">[docs]</a>    <span class="k">def</span> <span class="nf">departures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slicerarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">criteriaarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param slab: slab from which the we want to get the departure</span>
<span class="sd">        :param slicerarg: anything your slicer function needs, default is None</span>
<span class="sd">        :param criteriaarg: anything your criteria function needs, default is None</span>
<span class="sd">        :param ref: result from get or equivalent precomputed</span>
<span class="sd">        :param statusbar: see :py:func:`statusbar` for details</span>

<span class="sd">        :returns: The departures of slab from the result of get</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sliced</span><span class="o">=</span><span class="n">TimeSlicer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slicerarg</span><span class="p">,</span><span class="n">criteriaarg</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="n">statusbar</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sliced</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">order</span><span class="o">=</span><span class="n">sliced</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">initialgrid</span><span class="o">=</span><span class="n">sliced</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;t&#39;</span> <span class="p">:</span> <span class="n">sliced</span><span class="o">=</span><span class="n">sliced</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>
        <span class="n">order2</span><span class="o">=</span><span class="n">sliced</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">sum</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ref</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">order2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order2</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
            <span class="n">out</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">asVariable</span><span class="p">(</span><span class="n">sliced</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ref</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">asVariable</span><span class="p">(</span><span class="n">sliced</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">ref</span><span class="p">)</span>
        <span class="c1"># put the axes back</span>
        <span class="n">out</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">id</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sliced</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">sliced</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">initialgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">initialgrid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="TimeSlicer.average"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.TimeSlicer.average">[docs]</a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slices</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">norm</span><span class="p">,</span><span class="n">criteriaarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the average of the result of slicer</span>

<span class="sd">        :param slab: the slab on which to operate</span>
<span class="sd">        :param slices: the slices for each part</span>
<span class="sd">        :param bounds: the length of each slice</span>
<span class="sd">        :param norm: the actual length of each &quot;season&quot;</span>
<span class="sd">        :param criteriaarg: arguments for criteria thing</span>

<span class="sd">        :returns: the average of slab, masked by criteria</span>
<span class="sd">          &quot;&quot;&quot;</span>
        <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>
        <span class="n">sh</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">slab</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">n</span>
        <span class="n">out</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">wout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusbar1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">statusbar</span><span class="p">)</span>
            <span class="n">sub</span><span class="o">=</span><span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
            <span class="n">msk</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">subb</span><span class="o">=</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">nrm</span><span class="o">=</span><span class="n">norm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">##             print sub,subb,nrm,&#39;are subb, nrm&#39;,len(sub),sum</span>
<span class="c1">##             if len(sub)==1:</span>
<span class="c1">##                 out[i]=slab[sub[0]]</span>
<span class="c1">##                 w=float(subb[0][1]-subb[0][0])/nrm</span>
<span class="c1">##                 msk=msk*w</span>
<span class="c1">##             else:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)):</span>
                <span class="n">w</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">subb</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">subb</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">nrm</span>
<span class="c1">##                 print j,w</span>
                <span class="n">m</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">slab</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">m</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">))</span><span class="o">*</span><span class="n">w</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">w</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="o">*</span><span class="n">slab</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">sub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">asma</span><span class="p">(),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">wout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">sum</span> <span class="ow">is</span> <span class="kc">False</span> <span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">wout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">##                 print &#39;case long:&#39;,wout[i,0,0]</span>
            <span class="k">else</span><span class="p">:</span>
<span class="c1">##                 print &#39;case 1:&#39;,out.shape,msk.shape,slab[sub[0]].asma().shape</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slab</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">asma</span><span class="p">()</span>
<span class="c1">##                 if sum is False:</span>
<span class="c1">##                     out[i] = out[i]/msk</span>

            <span class="k">if</span> <span class="n">criteriaarg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msk</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">asVariable</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">b</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">msk</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">msk</span><span class="p">,[</span><span class="n">norm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">norm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">norm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],],</span><span class="n">criteriaarg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusbar2</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">,</span><span class="n">wout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span></div>
    
    <span class="k">def</span> <span class="nf">statusbar1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">statusbar</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">genutil</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">status</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span><span class="o">=</span><span class="n">statusbar</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">tot</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">status</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="n">genutil</span><span class="o">.</span><span class="n">statusbar</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="n">prev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">statusbar2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">statusbar</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">elif</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span><span class="o">=</span><span class="n">statusbar</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">tot</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="nb">eval</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]</span>  <span class="p">:</span>
                            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]</span>  <span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">type</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span><span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span> <span class="n">statusbar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="monthBasedSlicer"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.monthBasedSlicer">[docs]</a><span class="k">def</span> <span class="nf">monthBasedSlicer</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    slicer function for the TimeSlicer class</span>
<span class="sd">    select months</span>
<span class="sd">    Author : Charles Doutriaux, doutriaux1@llnl.gov</span>
<span class="sd">    Original Date: April 2001</span>
<span class="sd">    Last Modified: October, 2001</span>
<span class="sd">    Input:</span>
<span class="sd">    :param tim: time axis</span>
<span class="sd">    :param arg: character string representing the desired month/season or integer(s)</span>
<span class="sd">             also you can pass a list of the months you want (string or integer)</span>
<span class="sd">             you can mix integer and strings</span>
<span class="sd">    Output:</span>
<span class="sd">      - </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First convert the input</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span> <span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TupleType</span><span class="p">]:</span>
        <span class="n">arg</span><span class="o">=</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
    <span class="c1"># Now convert the strings and add to the valid months</span>
    <span class="n">months</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">==</span><span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">=</span><span class="n">getMonthIndex</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span> <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">slices</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">seaslength</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sub</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">subb</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">subs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bnds</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">cal</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">()</span>
    <span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
    <span class="n">nt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="n">b0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">units</span><span class="p">)</span>
        <span class="n">b1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">units</span><span class="p">)</span>
        <span class="n">iout</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1"># Now figures out what the length of</span>
        <span class="c1"># the requested season</span>
        <span class="n">b</span><span class="o">=</span><span class="n">b0</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
        <span class="n">yr</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">year</span>
        <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span><span class="p">:</span>
            <span class="n">bb</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bb</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">##         if b.cmp(bb)&gt;0:</span>
<span class="c1">##             yr=yr+1</span>
        <span class="c1"># do we span 2 years ?</span>
        <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="c1"># yes</span>
            <span class="c1">## Are we in the part before the year&#39;s end</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">month</span><span class="o">&lt;</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1">## no</span>
                <span class="n">t0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">## yes</span>
<span class="c1">##                 print &#39;in here ?&#39;,b</span>
                <span class="n">t0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>              
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">12</span><span class="p">:</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">cal</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">cal</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span>
<span class="c1">##         if i&lt;5:print &#39;t1 after:&#39;,t1.tocomp(cal)</span>
        <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span>
        <span class="n">lenseas</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># Now checks if we overlap the season</span>
<span class="c1">##         if i&lt;5: print &#39;---&#39;,i,b0.tocomp(cal),b1.tocomp(cal),t0.tocomp(cal),t1.tocomp(cal)</span>
<span class="c1">##         if i&lt;5: print &#39;---&#39;,i,t0.cmp(b0),b1.cmp(t1),t1.cmp(b0)</span>
        <span class="k">if</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>        <span class="c1"># cell starts after season started</span>
            <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">:</span>    <span class="c1"># and ends before the season ends</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>        <span class="c1"># all before the season</span>
                <span class="n">iout</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>                      <span class="c1"># ends during the season</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
            <span class="c1"># Now check if if this is exactly one season long !</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">b0</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="n">lenseas</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">iout</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">elif</span> <span class="n">t1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>      <span class="c1"># end season after beginning of cell ?</span>
<span class="c1">##             print &#39;index,t1&gt;b0 time&#39;,i,tim[i],t1.tocomp(),b0.tocomp(),b</span>
            <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>             <span class="c1"># and ends after the end</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
<span class="c1">##                 print &#39;haha&#39;,len(months),t0.value</span>
<span class="c1">##                 if len(months)==12 or lenseas==(b1.value-b1.value):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span><span class="o">==</span><span class="mi">12</span><span class="p">:</span>
<span class="c1">##                     print &quot;i:&quot;,i,tim[i]</span>
<span class="c1">##                     print &quot;sub :&quot;,sub</span>
<span class="c1">##                     print &quot;subb:&quot;,subb</span>
<span class="c1">##                     print &quot;subs:&quot;,subs</span>
                    <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                    <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
                    <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">sub</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">subb</span><span class="o">=</span><span class="p">[[</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="p">]]</span>
                    <span class="n">subs</span><span class="o">=</span><span class="p">[[</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="c1"># but ends during</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span><span class="o">==</span><span class="mi">12</span> <span class="ow">and</span> <span class="n">b1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                    <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
                    <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">sub</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">subb</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">subs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iout</span><span class="o">=</span><span class="mi">1</span>
<span class="c1">##         if i&lt;5: print &quot;ok we got iuot: &quot;,iout,sub</span>
        <span class="k">if</span> <span class="n">iout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">!=</span><span class="p">[]:</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
                <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">sub</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">subb</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">subs</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1">## ??? Add something here for 12 omnths span....</span>
        <span class="c1">## like remenbering which season we&#39;re at, etc....</span>
    <span class="k">if</span> <span class="n">sub</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
<span class="c1">##         print &#39;using:&#39;,subs</span>
        <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Now looks for the cyclical thing</span>
    <span class="c1"># ??? do something here as well......</span>
    <span class="k">return</span> <span class="n">slices</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">seaslength</span></div>


<div class="viewcode-block" id="dayBasedSlicer"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.dayBasedSlicer">[docs]</a><span class="k">def</span> <span class="nf">dayBasedSlicer</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    slicer function for the TimeSlicer class</span>
<span class="sd">    select days</span>
<span class="sd">    Author : Charles Doutriaux, doutriaux1@llnl.gov</span>
<span class="sd">    Original Date: June, 2003</span>

<span class="sd">    :param tim: time axis</span>
<span class="sd">    :param arg: string representing the desired day/days or day number(s) (jan 1st, is day 0, feb 29th is day 59.5...)</span>
<span class="sd">             day are represented as &quot;Jan-01&quot; &quot;January-01&quot; &quot;jan-1&quot;, &quot;1-january&quot;, case does not matter</span>
<span class="sd">             days can be represented by 2 numbers but then month is assumed to be first ! e.g &quot;01-25&quot; = &quot;jan-25&quot;</span>
<span class="sd">             you can mix definitions</span>
<span class="sd">    :type arg: str</span>
<span class="sd">    Output:</span>
<span class="sd">      - </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First convert the input</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span> <span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TupleType</span><span class="p">]:</span>
        <span class="n">arg</span><span class="o">=</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
    <span class="c1"># Now convert the strings and add to the valid month/day tupples</span>
    <span class="n">tupples</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)):</span>
        <span class="n">subarg</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">subarg</span><span class="p">)</span><span class="o">!=</span><span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s2">&quot;Error, arguments to dayBasedSlicer must be strings&quot;</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">subarg</span><span class="p">,</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">subarg</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">subarg</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">subarg</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">subarg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index</span><span class="o">==</span><span class="mf">59.5</span><span class="p">:</span>
                        <span class="n">subarg</span><span class="o">=</span><span class="s1">&#39;feb-29&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;month since 1997&#39;</span><span class="p">)</span>
                        <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">tocomp</span><span class="p">()</span>
                        <span class="n">subarg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s2">&quot;Error, dayBasedSlicer args must have &#39;-&#39; or &#39;/&#39; as month/day separator&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">day</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">month</span><span class="o">=</span><span class="n">getMonthIndex</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">month</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">day</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">month</span><span class="o">=</span><span class="n">getMonthIndex</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">month</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s2">&quot;Error dayBasedSlicer couldn&#39;t understand argument: &quot;</span><span class="o">+</span><span class="n">subarg</span>
        <span class="n">tupples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">day</span><span class="p">,</span><span class="n">month</span><span class="p">])</span>
    <span class="n">slices</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">seaslength</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sub</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">subb</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">subs</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bnds</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">cal</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">()</span>
    <span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
    <span class="n">nt</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
        <span class="n">b0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">units</span><span class="p">)</span>
        <span class="n">b1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">units</span><span class="p">)</span>
        <span class="n">iout</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1"># Now figures out what the length of</span>
        <span class="c1"># the requested season</span>
        <span class="n">b</span><span class="o">=</span><span class="n">b0</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
        <span class="n">yr</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">year</span>
        <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span><span class="p">:</span>
            <span class="n">bb</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bb</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">yr</span><span class="o">=</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1"># do we span 2 years ?</span>
        <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="c1"># yes</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">12</span><span class="p">:</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t0</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">12</span><span class="p">:</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">yr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span>
        <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span>
        <span class="n">lenseas</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="c1">##         print &#39;t0,b0,t1,b1&#39;,t0,b0,t1,b1</span>
        <span class="c1"># Now checks if we overlap the season</span>
        <span class="k">if</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>        <span class="c1"># cell starts before season</span>
            <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>            <span class="c1"># and ends after the season</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>        <span class="c1"># all before the season</span>
                <span class="n">iout</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>                      <span class="c1"># ends during the season</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
            <span class="c1"># Now check if if this is exactly one season long !</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">b0</span><span class="o">.</span><span class="n">value</span><span class="o">==</span><span class="n">lenseas</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t0</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">iout</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">elif</span> <span class="n">t1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>      <span class="c1"># end season after beginning of cell ?</span>
<span class="c1">##             print &#39;index,time&#39;,i,tim[i]</span>
            <span class="k">if</span> <span class="n">b1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>             <span class="c1"># and ends after the end</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
<span class="c1">##                 print &#39;haha&#39;,len(months),t0.value</span>
<span class="c1">##                 if len(months)==12 or lenseas==(b1.value-b1.value):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span><span class="o">==</span><span class="mi">12</span><span class="p">:</span>
<span class="c1">##                     print &quot;i:&quot;,i,tim[i]</span>
<span class="c1">##                     print &quot;sub :&quot;,sub</span>
<span class="c1">##                     print &quot;subb:&quot;,subb</span>
<span class="c1">##                     print &quot;subs:&quot;,subs</span>
                    <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                    <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
                    <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">sub</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">subb</span><span class="o">=</span><span class="p">[[</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="p">]]</span>
                    <span class="n">subs</span><span class="o">=</span><span class="p">[[</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="c1"># but ends during</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">subb</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b0</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">b1</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span><span class="o">==</span><span class="mi">12</span> <span class="ow">and</span> <span class="n">b1</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                    <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
                    <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lenseas</span><span class="p">,</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">sub</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">subb</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">subs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iout</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">iout</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">!=</span><span class="p">[]:</span>
                <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
                <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
                <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">sub</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">subb</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">subs</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1">## ??? Add something here for 12 omnths span....</span>
        <span class="c1">## like remenbering which season we&#39;re at, etc....</span>
    <span class="k">if</span> <span class="n">sub</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subb</span><span class="p">)</span>
<span class="c1">##         print &#39;using:&#39;,subs</span>
        <span class="n">seaslength</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Now looks for the cyclical thing</span>
    <span class="c1"># ??? do something here as well......</span>
    <span class="k">return</span> <span class="n">slices</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">seaslength</span></div>

<span class="k">def</span> <span class="nf">weekday</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">calendar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;days since 0&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;days since 0&#39;</span><span class="p">,</span><span class="n">calendar</span><span class="p">)</span>        
    <span class="n">d</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;monday&#39;</span>
    <span class="k">elif</span> <span class="n">d</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;tuesday&#39;</span>
    <span class="k">elif</span> <span class="n">d</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;wednesday&#39;</span>
    <span class="k">elif</span> <span class="n">d</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;thursday&#39;</span>
    <span class="k">elif</span> <span class="n">d</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;friday&#39;</span>
    <span class="k">elif</span> <span class="n">d</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;saturday&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;sunday&#39;</span>



<div class="viewcode-block" id="generalCriteria"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.generalCriteria">[docs]</a><span class="k">def</span> <span class="nf">generalCriteria</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="n">mask</span><span class="p">,</span><span class="n">spread</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default Conditions:</span>
<span class="sd">        50% of the data</span>
<span class="sd">        AND</span>
<span class="sd">        Centroid &lt; x (in absolute value), centroid is always between 0 (perfect) and 1, (not perfect)</span>
<span class="sd">        by default centroid is not used</span>

<span class="sd">    Author: Charles Doutriaux, doutriaux1@llnl.gov</span>

<span class="sd">    Usage:</span>
<span class="sd">        generalCriteria(slab,sliced,slices,arg)</span>
<span class="sd">    :param slab: the original slab</span>
<span class="sd">    :param mask: the actual percentage of data in each subset used to produce the slab</span>
<span class="sd">            the bounds of its first (time) dimension must be correct</span>
<span class="sd">            they will be used by centroid</span>
<span class="sd">    :param spread: the begining and end time of the slice processed</span>
<span class="sd">    :param arg: A list of arguments</span>
<span class="sd">            First represent the % of value present to retain a slice</span>
<span class="sd">            Second represent the value of the centroid (between 0: perfect and 1: bad</span>
<span class="sd">            If you do not want to use one these criteria pass None</span>
<span class="sd">            if you would rather use a cyclicalcnetroid pass: &quot;cyclical&quot; as an extra argument</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reads the arguments</span>
    <span class="n">slab</span><span class="o">=</span><span class="n">MV2</span><span class="o">.</span><span class="n">asVariable</span><span class="p">(</span><span class="n">slab</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">shape</span>
<span class="c1">##     print slab,mask,spread,arg</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">min</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">centro</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># prepare the mask</span>
<span class="c1">##     print &#39;Mask shape&#39;,mask.shape</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fmask</span><span class="o">=</span><span class="n">MV2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
        <span class="n">fmask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">fmask</span><span class="p">,</span><span class="nb">min</span><span class="p">)</span>
<span class="c1">##         print &#39;fmask,slab&#39;,fmask.shape,slab.shape</span>
<span class="c1">##         import sys,vcs</span>
<span class="c1">##         x=vcs.init()</span>
<span class="c1">##         x.plot(mask)</span>
<span class="c1">##         sys.stdin.readline()</span>
<span class="c1">##         x.clear()</span>
<span class="c1">##         x.plot(fmask)</span>
        <span class="n">slab</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmask</span><span class="p">,</span><span class="n">slab</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">centro</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">a</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">a</span><span class="o">=</span><span class="n">MV2</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mask</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">a</span>
        <span class="k">if</span> <span class="s1">&#39;cyclical&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="n">c</span><span class="o">=</span><span class="n">cyclicalcentroid</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">spread</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">=</span><span class="n">centroid</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">spread</span><span class="p">)</span>
            <span class="n">c</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">slab</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">centro</span><span class="p">),</span><span class="n">slab</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slab</span></div>


<div class="viewcode-block" id="setAxisTimeBoundsDaily"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setAxisTimeBoundsDaily">[docs]</a><span class="k">def</span> <span class="nf">setAxisTimeBoundsDaily</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the bounds correctly for the time axis (beginning to end of day)</span>
<span class="sd">    Usage:</span>
<span class="sd">    tim=s.getTime()</span>
<span class="sd">    cdutil.times.setAxisTimeBoundsMonthly(tim,frequency=1)</span>
<span class="sd">    e.g. for twice-daily data use frequency=2</span>
<span class="sd">         for 6 hourly data use frequency=4</span>
<span class="sd">         for   hourly data use frequency=24</span>
<span class="sd">    Origin of day is always midnight</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">axis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tim</span><span class="o">.</span><span class="n">isTime</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span><span class="s1">&#39;Time Axis only please !&#39;</span>
    <span class="k">if</span> <span class="n">tim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
    <span class="n">timc</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
    <span class="n">bnds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">frequency</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">t</span><span class="o">=</span><span class="n">timc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">d</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">day</span>
        <span class="n">m</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">month</span>
        <span class="n">y</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">year</span>
        <span class="n">h</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">frequency</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">h</span><span class="o">&lt;</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">frequency</span><span class="p">):</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">frequency</span><span class="p">))</span>
                <span class="n">t2</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">frequency</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Hours</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
                <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
                <span class="n">t2</span><span class="o">=</span><span class="n">t2</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span>
        <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">t2</span><span class="o">.</span><span class="n">value</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">bnds</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setSlabTimeBoundsDaily"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setSlabTimeBoundsDaily">[docs]</a><span class="k">def</span> <span class="nf">setSlabTimeBoundsDaily</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the bounds correctly for the time axis (beginning to end of day)</span>
<span class="sd">    for &#39;frequency&#39;-daily data</span>
<span class="sd">    Usage:</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsDaily(slab,frequency=1)</span>
<span class="sd">    e.g. for twice-daily data use frequency=2</span>
<span class="sd">         for 6 hourly data use frequency=4</span>
<span class="sd">         for   hourly data use frequency=24</span>
<span class="sd">    Origin of day is always midnight</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">setAxisTimeBoundsDaily</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setTimeBoundsDaily"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setTimeBoundsDaily">[docs]</a><span class="k">def</span> <span class="nf">setTimeBoundsDaily</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the bounds correctly for the time axis (beginning to end of day)</span>
<span class="sd">    for &#39;frequency&#39;-daily data</span>
<span class="sd">    Usage:</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsDaily(slab,frequency=1)</span>
<span class="sd">    or</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsDaily(time_axis,frequency=1)</span>
<span class="sd">    e.g. for twice-daily data use frequency=2</span>
<span class="sd">         for 6 hourly data use frequency=4</span>
<span class="sd">         for   hourly data use frequency=24</span>
<span class="sd">    Origin of day is always midnight</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">cdms2</span><span class="o">.</span><span class="n">AbstractAxis</span><span class="p">):</span>
        <span class="n">setAxisTimeBoundsDaily</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">cdms2</span><span class="o">.</span><span class="n">MV2</span><span class="o">.</span><span class="n">AbstractVariable</span><span class="p">):</span>
        <span class="n">setSlabTimeBoundsDaily</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setAxisTimeBoundsMonthly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setAxisTimeBoundsMonthly">[docs]</a><span class="k">def</span> <span class="nf">setAxisTimeBoundsMonthly</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span><span class="n">stored</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the bounds correctly for the time axis (beginning to end of month)</span>
<span class="sd">    Set stored to 1 to indicate that your data are stored at the end of the month</span>
<span class="sd">    Usage:</span>
<span class="sd">    tim=s.getTime()</span>
<span class="sd">    cdutil.times.setAxisTimeBoundsMonthly(tim,stored=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">axis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tim</span><span class="o">.</span><span class="n">isTime</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span><span class="s1">&#39;Time Axis only please !&#39;</span>
    <span class="k">if</span> <span class="n">tim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
    <span class="n">timc</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
    <span class="n">bnds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">t</span><span class="o">=</span><span class="n">timc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">d</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">day</span>
        <span class="n">m</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">month</span>
        <span class="n">y</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">year</span>
        <span class="k">if</span> <span class="n">stored</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">d</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span> <span class="c1">#data stored at the end of the month</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">==</span><span class="mi">1</span> <span class="p">:</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">==</span><span class="mi">0</span> <span class="p">:</span> <span class="n">m</span><span class="o">=</span><span class="mi">12</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Month</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">t2</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span>
        <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">t2</span><span class="o">.</span><span class="n">value</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">bnds</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setSlabTimeBoundsMonthly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setSlabTimeBoundsMonthly">[docs]</a><span class="k">def</span> <span class="nf">setSlabTimeBoundsMonthly</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="n">stored</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sets the bounds correctly for the time axis for monthly data stored</span>
<span class="sd">    without bounds.</span>
<span class="sd">    Set stored to 1 to indicate that your data are stored at the end of the month</span>
<span class="sd">    Usage:</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsMonthly(slab,stored=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">setAxisTimeBoundsMonthly</span><span class="p">(</span><span class="n">tim</span><span class="p">,</span><span class="n">stored</span><span class="o">=</span><span class="n">stored</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setTimeBoundsMonthly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setTimeBoundsMonthly">[docs]</a><span class="k">def</span> <span class="nf">setTimeBoundsMonthly</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">stored</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sets the bounds correctly for the time axis (beginning to end of month)</span>
<span class="sd">    Set stored to 1 to indicate that your data are stored at the end of the month</span>
<span class="sd">    Usage:</span>
<span class="sd">    tim=s.getTime()</span>
<span class="sd">    cdutil.times.setAxisTimeBoundsMonthly(s,stored=0)</span>
<span class="sd">    or</span>
<span class="sd">    cdutil.times.setAxisTimeBoundsMonthly(tim,stored=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">cdms2</span><span class="o">.</span><span class="n">AbstractAxis</span><span class="p">):</span>
        <span class="n">setAxisTimeBoundsMonthly</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">stored</span><span class="o">=</span><span class="n">stored</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">cdms2</span><span class="o">.</span><span class="n">MV2</span><span class="o">.</span><span class="n">AbstractVariable</span><span class="p">):</span>
        <span class="n">setSlabTimeBoundsMonthly</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">stored</span><span class="o">=</span><span class="n">stored</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setAxisTimeBoundsYearly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setAxisTimeBoundsYearly">[docs]</a><span class="k">def</span> <span class="nf">setAxisTimeBoundsYearly</span><span class="p">(</span><span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sets the bounds correctly for the time axis (beginning to end of year)</span>
<span class="sd">    Usage:</span>
<span class="sd">    tim=s.getTime()</span>
<span class="sd">    cdutil.times.setAxisTimeBoundsYearly(tim)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">axis</span>
    <span class="k">if</span> <span class="n">tim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">units</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">units</span>
    <span class="n">timc</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
    <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
    <span class="n">bnds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">t</span><span class="o">=</span><span class="n">timc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">y</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">year</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">t2</span><span class="o">=</span><span class="n">t2</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">units</span><span class="p">,</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">value</span>
        <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">t2</span><span class="o">.</span><span class="n">value</span>
    <span class="n">tim</span><span class="o">.</span><span class="n">setBounds</span><span class="p">(</span><span class="n">bnds</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setSlabTimeBoundsYearly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setSlabTimeBoundsYearly">[docs]</a><span class="k">def</span> <span class="nf">setSlabTimeBoundsYearly</span><span class="p">(</span><span class="n">slab</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sets the bounds correctly for the time axis for yearly data</span>
<span class="sd">    Usage:</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsYearly(slab)</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="n">tim</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">setAxisTimeBoundsYearly</span><span class="p">(</span><span class="n">tim</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="setTimeBoundsYearly"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.setTimeBoundsYearly">[docs]</a><span class="k">def</span> <span class="nf">setTimeBoundsYearly</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sets the bounds correctly for the time axis for yearly data</span>
<span class="sd">    Usage:</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsYearly(slab)</span>
<span class="sd">    or</span>
<span class="sd">    cdutil.times.setSlabTimeBoundsYearly(time_axis)</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">cdms2</span><span class="o">.</span><span class="n">AbstractAxis</span><span class="p">):</span>
        <span class="n">setAxisTimeBoundsYearly</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">cdms2</span><span class="o">.</span><span class="n">MV2</span><span class="o">.</span><span class="n">AbstractVariable</span><span class="p">):</span>
        <span class="n">setSlabTimeBoundsYearly</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="insert_monthly_seasons"><a class="viewcode-back" href="../../CDUtil/Modules/times.html#cdutil.times.insert_monthly_seasons">[docs]</a><span class="k">def</span> <span class="nf">insert_monthly_seasons</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">seasons</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes data assumed to be in monthly increments (1,2,3,etc...)</span>
<span class="sd">    And tries to add seasons into it is actually missing</span>
<span class="sd">    For this takes each time step, and see if a number of &quot;season&quot; could be inserted between these two</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
    <span class="n">axes</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
    <span class="n">cal</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">()</span>
    <span class="n">tc</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">asComponentTime</span><span class="p">()</span>
    <span class="n">tbnd</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">adds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="n">seasons</span><span class="p">:</span>
<span class="c1">##         print &#39;Dealing with season:&#39;,season</span>
        <span class="n">axv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bnds</span> <span class="o">=</span><span class="p">[]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">getMonthIndex</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">tscan</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">tbnd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span> <span class="c1"># end of current time step</span>
            <span class="n">tnext</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">tbnd</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span> <span class="c1"># beginnig of next time step</span>

            <span class="c1"># Begining of the season</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">comptime</span><span class="p">(</span><span class="n">tscan</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tb</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">tscan</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
            <span class="c1"># end of season</span>
            <span class="n">te</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Month</span><span class="p">)</span>
<span class="c1">##             print season,tb,te,tscan,tnext,tb.cmp(tscan)&gt;-1, te.cmp(tnext)&lt;1,tb.cmp(tscan)&gt;-1 and te.cmp(tnext)&lt;1</span>
            <span class="c1"># ok now we&#39;re going to create the &quot;n&quot; seasons</span>
            <span class="k">while</span>  <span class="n">te</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">tnext</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tb</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">tscan</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">t0</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">t1</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">cal</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">bnds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">])</span>
                    <span class="c1"># ok that was the bounds, now computes the mid value</span>
                    <span class="n">tm</span> <span class="o">=</span> <span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">((</span><span class="n">t0</span><span class="o">+</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
                    <span class="c1"># ok sometimes we need to round up these things (months since especially)</span>
                    <span class="n">tm</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">units</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">axv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>
<span class="c1">##                     print &#39;adding:&#39;,i,season,tb,te</span>
                <span class="n">tb</span><span class="o">=</span><span class="n">tb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
                <span class="n">te</span><span class="o">=</span><span class="n">te</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cdtime</span><span class="o">.</span><span class="n">Year</span><span class="p">)</span>
        <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">axv</span><span class="p">)</span>
<span class="c1">##         print &#39;N is:&#39;,n,&#39;for season&#39;,season</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">n</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">MV2</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">axv</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bnds</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">designateTime</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">units</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">setCalendar</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ax</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
            <span class="n">adds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">adds</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="n">adds</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mergeTime</span><span class="p">(</span><span class="n">adds</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s1">&#39;fill_value&#39;</span><span class="p">,</span><span class="mf">1.e20</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span></div>
    
<span class="k">class</span> <span class="nc">ASeason</span><span class="p">(</span><span class="n">TimeSlicer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="o">=</span><span class="n">monthBasedSlicer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">=</span><span class="n">generalCriteria</span>

<span class="k">class</span> <span class="nc">Seasons</span><span class="p">(</span><span class="n">ASeason</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">seasons</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__call__</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seasons</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">seasons</span><span class="o">=</span><span class="n">seasons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">seasons</span><span class="p">)</span><span class="o">==</span><span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span>
            <span class="n">seasons</span><span class="o">=</span><span class="p">[</span><span class="n">seasons</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seasons</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">seasons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">TupleType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">IntType</span><span class="p">]:</span>
                <span class="n">seasons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">getMonthString</span><span class="p">(</span><span class="n">seasons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="o">=</span><span class="n">seasons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slicer</span><span class="o">=</span><span class="n">monthBasedSlicer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">=</span><span class="n">generalCriteria</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">month_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">):</span>
        <span class="n">t</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">units</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s2">&quot;month&quot;</span><span class="p">:</span>
            <span class="n">tc</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
            <span class="n">tc2</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">tocomp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
            <span class="n">relyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1">#if tc.cmp(cdtime.comptime(relyear))&lt;1 and tc2.cmp(cdtime.comptime(relyear))&gt;-1:</span>
                <span class="c1">#slab.__saved_time__=t.units</span>
                <span class="c1">#t.toRelativeTime(&quot;months since %i&quot; % (relyear - len(t)/10))</span>
                <span class="c1">#t.toRelativeTime(&quot;months since 1&quot;)# % (relyear - len(t)/10))</span>
            <span class="n">slab</span><span class="o">.</span><span class="n">__saved_time__</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">units</span>
            <span class="n">t</span><span class="o">.</span><span class="n">toRelativeTime</span><span class="p">(</span><span class="s2">&quot;months since &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tc</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">u</span>

    <span class="k">def</span> <span class="nf">month_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">merged</span><span class="p">,</span><span class="n">slab</span><span class="p">):</span>
           <span class="n">t</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="s2">&quot;__saved_time__&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
               <span class="n">T</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
               <span class="n">T</span><span class="o">.</span><span class="n">toRelativeTime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">T</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
               <span class="n">T</span><span class="o">=</span><span class="n">merged</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
               <span class="n">T</span><span class="o">.</span><span class="n">toRelativeTime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">T</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
               <span class="k">del</span><span class="p">(</span><span class="n">slab</span><span class="o">.</span><span class="n">__saved_time__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slicerarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">criteriaarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the seasons asked for and return them in chronological order</span>
<span class="sd">        i.e. if you asked for DJF and JJA and the first season of your dataset is JJA you will have a JJA first !!!!</span>
<span class="sd">        Check your time axis coordinate !!!</span>
<span class="sd">        slicerarg will be ignored</span>
<span class="sd">        it is recomended to use Season(slab,criteria=mycriteriaarguments) syntax</span>
<span class="sd">        rather than Season(slab,None,None,mycriteriaarguments)</span>
<span class="sd">        Now for the original doc of the get function see get2__doc__:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdat_info</span><span class="o">.</span><span class="n">pingPCMDIdb</span><span class="p">(</span><span class="s2">&quot;cdat&quot;</span><span class="p">,</span><span class="s2">&quot;cdutil.times.Seasons.get -</span><span class="si">%s</span><span class="s2">-&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span>
        <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">month_fix</span><span class="p">(</span><span class="n">slab</span><span class="p">)</span>
        <span class="n">s</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">i</span><span class="o">=-</span><span class="mi">1</span>
        <span class="n">missing_seasons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusbar1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">),</span><span class="n">statusbar</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TimeSlicer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">season</span><span class="p">,</span><span class="n">criteriaarg</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="n">statusbar</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># ok no data for that season</span>
                <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">missing_seasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusbar2</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mergeTime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="n">statusbar</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="s1">&#39;fill_value&#39;</span><span class="p">,</span><span class="mf">1.e20</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">month_restore</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">slab</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="nf">departures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slicerarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">criteriaarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the departures for the list of season you specified, returned in chronological order</span>
<span class="sd">        i.e. if you asked for DJF and JJA and the first season of your dataset is JJA you will have a JJA first !!!!</span>
<span class="sd">        Check your time axis coordinate !!!</span>
<span class="sd">        To pass a specific array from which to compute departures, please pass 1 per season (or None if we should compute it)</span>
<span class="sd">        for info one default departures see: departures2.__doc__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdat_info</span><span class="o">.</span><span class="n">pingPCMDIdb</span><span class="p">(</span><span class="s2">&quot;cdat&quot;</span><span class="p">,</span><span class="s2">&quot;cdutil.times.Seasons.departures -</span><span class="si">%s</span><span class="s2">-&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span>
        <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">month_fix</span><span class="p">(</span><span class="n">slab</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span><span class="s2">&quot;reference must be a variable (MV2)&quot;</span>
        <span class="n">s</span><span class="o">=</span><span class="p">[]</span>
        <span class="c1"># Loop through the seasons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">[</span><span class="n">i</span><span class="p">],]</span>
            <span class="c1"># Do we want a statusbar ?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span>
                    <span class="n">statusbar</span><span class="o">=</span><span class="nb">str</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">statusbar</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">str</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">)]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">statusbar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">)])</span>
            <span class="c1"># Did we pass a reference to copmute the departures from ?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ref</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isTime</span><span class="p">():</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span><span class="s2">&quot;The reference time (or first) dimension does not match the number of dimensions&quot;</span>
                <span class="n">newref</span><span class="o">=</span><span class="n">ref</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newref</span><span class="o">=</span><span class="kc">None</span>
            <span class="c1"># now computes the departures</span>
            <span class="n">out</span><span class="o">=</span><span class="n">TimeSlicer</span><span class="o">.</span><span class="n">departures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">slicerarg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">criteriaarg</span><span class="o">=</span><span class="n">criteriaarg</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="n">statusbar</span><span class="p">,</span><span class="n">ref</span><span class="o">=</span><span class="n">newref</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
            <span class="c1"># Adds it to the list</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">departures_seasons</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span> <span class="n">statusbar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Now merges the stuff</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mergeTime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="n">statusbar</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="s1">&#39;fill_value&#39;</span><span class="p">,</span><span class="mf">1.e20</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">month_restore</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">slab</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span>
                                    
    <span class="k">def</span> <span class="nf">climatology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="n">criteriaarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">criteriaargclim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the climatology from a slab</span>

<span class="sd">        :param slab: A cdms2 transient variable</span>
<span class="sd">        :type slab: cdms2.tvariable.TransientVariable</span>

<span class="sd">        :param criteriaarg: the argument for criteria function when slicing the season (and clim)</span>
<span class="sd">        :param criteriaargclim: the argument for criteria function when averaging the seasons together</span>
<span class="sd">                            if different from criteriarg</span>

<span class="sd">        :returns: The Average of the seasons in the order passed when constructing it</span>
<span class="sd">            i.e if DJF and JJA are asked, the output will have the average DJF first, then the average JJA</span>
<span class="sd">            2 criteria can be passed one for the slicing part and one for the climatology part</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdat_info</span><span class="o">.</span><span class="n">pingPCMDIdb</span><span class="p">(</span><span class="s2">&quot;cdat&quot;</span><span class="p">,</span><span class="s2">&quot;cdutil.times.Seasons.climatology -</span><span class="si">%s</span><span class="s2">-&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span>
        <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">month_fix</span><span class="p">(</span><span class="n">slab</span><span class="p">)</span>
        <span class="c1">#if criteriaargclim is None: criteriaargclim=criteriaarg</span>
        <span class="n">order</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">initialgrid</span> <span class="o">=</span> <span class="n">slab</span><span class="o">.</span><span class="n">getGrid</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;t&#39;</span> <span class="p">:</span> <span class="n">slab</span><span class="o">=</span><span class="n">slab</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;t...&#39;</span><span class="p">)</span>
        <span class="n">timeaxis</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">timecalendar</span><span class="o">=</span><span class="n">timeaxis</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">()</span>
        <span class="n">sh</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">slab</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">nseason</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span>
        <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">nseason</span>
        <span class="n">s</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">vals</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nseason</span><span class="p">,</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">bnds</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nseason</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">tim</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nseason</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span>
                    <span class="n">statusbar</span><span class="o">=</span><span class="nb">str</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)])</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">statusbar</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">str</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">statusbar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)])</span>
            <span class="n">months</span><span class="o">=</span><span class="n">getMonthIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="p">:</span> <span class="n">months</span><span class="o">=</span><span class="n">months</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">12</span>
            <span class="n">v1</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;months since 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;days since 0&#39;</span><span class="p">,</span><span class="n">timecalendar</span><span class="p">)</span>
            <span class="n">v2</span><span class="o">=</span><span class="n">cdtime</span><span class="o">.</span><span class="n">reltime</span><span class="p">(</span><span class="n">months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;months since 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">torel</span><span class="p">(</span><span class="s1">&#39;days since 0&#39;</span><span class="p">,</span><span class="n">timecalendar</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="n">v2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">v1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">v2</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">TimeSlicer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slab</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">criteriaarg</span><span class="p">,</span><span class="n">statusbar</span><span class="o">=</span><span class="n">statusbar</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="nb">sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">tmp</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">tmp</span>
            <span class="n">tmp2</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmp2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tmp2</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp2</span><span class="o">=</span><span class="n">tmp2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">MV2</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="n">tmp2</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">tmp2</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
            <span class="n">tim</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
            <span class="n">bnd</span><span class="o">=</span><span class="n">tim</span><span class="o">.</span><span class="n">getBounds</span><span class="p">()</span>
            <span class="n">tot</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cdms2</span><span class="o">.</span><span class="n">isVariable</span><span class="p">(</span><span class="n">tmp2</span><span class="p">):</span>
                <span class="n">tmp2</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">asVariable</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
            <span class="n">tmp2</span><span class="o">.</span><span class="n">setAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tim</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">criteriaargclim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">tmp2</span><span class="p">,</span><span class="n">bnds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">criteriaargclim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">sum</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">tmp2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="o">*</span><span class="n">tmp2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusbar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seasons</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span> <span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statusbar</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">type</span><span class="p">([]),</span><span class="nb">type</span><span class="p">(())]:</span> <span class="n">statusbar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createAxis</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;time&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;days since 0&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">designateTime</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">setCalendar</span><span class="p">(</span><span class="n">tim</span><span class="o">.</span><span class="n">getCalendar</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">getAxisList</span><span class="p">()</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
        <span class="n">s</span><span class="o">=</span><span class="n">cdms2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="n">slab</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span><span class="s1">&#39;fill_value&#39;</span><span class="p">,</span><span class="mf">1.e20</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">setAxisList</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initialgrid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">setGrid</span><span class="p">(</span><span class="n">initialgrid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">month_restore</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">slab</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">getOrder</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">!=</span><span class="n">order</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
    
<span class="c1">## Seasons.get.__doc__=Seasons.get.__doc__+Seasons._get.__doc__</span>
<span class="c1">## Seasons.departures.__doc__=Seasons.departures.__doc__+Seasons._departures.__doc__</span>

<span class="n">ANNUALCYCLE</span><span class="o">=</span><span class="n">Seasons</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">])</span>
<span class="n">SEASONALCYCLE</span><span class="o">=</span><span class="n">Seasons</span><span class="p">([</span><span class="s1">&#39;DJF&#39;</span><span class="p">,</span><span class="s1">&#39;MAM&#39;</span><span class="p">,</span><span class="s1">&#39;JJA&#39;</span><span class="p">,</span><span class="s1">&#39;SON&#39;</span><span class="p">])</span>

<span class="n">DJF</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;DJF&#39;</span><span class="p">)</span>
<span class="n">MAM</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;MAM&#39;</span><span class="p">)</span>
<span class="n">JJA</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;JJA&#39;</span><span class="p">)</span>
<span class="n">SON</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;SON&#39;</span><span class="p">)</span>
<span class="n">JAN</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;JAN&#39;</span><span class="p">)</span>
<span class="n">FEB</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;FEB&#39;</span><span class="p">)</span>
<span class="n">MAR</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;MAR&#39;</span><span class="p">)</span>
<span class="n">APR</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;APR&#39;</span><span class="p">)</span>
<span class="n">MAY</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;MAY&#39;</span><span class="p">)</span>
<span class="n">JUN</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;JUN&#39;</span><span class="p">)</span>
<span class="n">JUL</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;JUL&#39;</span><span class="p">)</span>
<span class="n">AUG</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;AUG&#39;</span><span class="p">)</span>
<span class="n">SEP</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;SEP&#39;</span><span class="p">)</span>
<span class="n">OCT</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;OCT&#39;</span><span class="p">)</span>
<span class="n">NOV</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;NOV&#39;</span><span class="p">)</span>
<span class="n">DEC</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;DEC&#39;</span><span class="p">)</span>

<span class="n">YEAR</span><span class="o">=</span><span class="n">Seasons</span><span class="p">(</span><span class="s1">&#39;JFMAMJJASOND&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Charles Doutriaux.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>